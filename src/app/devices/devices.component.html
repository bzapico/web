<!-- Component title -->
<div class="row row-title mb-4">
  <div class="col-lg-2">
    <h2>Devices</h2>
  </div>
  <div class="col-lg-8">
    <div 
      class="close-group-button">
      <button  
        *ngIf="activeGroupId !== 'ALL'" 
        (click)="changeActiveGroup('ALL')"
        class="button">
        <span>  {{getGroupName(activeGroupId) | abbreviate}}<span class="close-trigger">X</span></span>
      </button>
    </div>
  </div>
  <div class="col-lg-2"></div>
</div>
<!-- Summary and devices status timeline row -->
<div *ngIf="devices.length === 0 ||  activeGroupId === 'ALL'"  class="row row-info">
  <!-- Summary group info card for all -->
  <div class="col-lg-4 h-100">
    <div class="card h-100">
      <div class="card-title-c">
        <h5 class="text-uppercase">Summary</h5>
      </div>
      <div *ngIf="groups.length > 0" class="summary-card">
        <div>
          <div class="circle summary-box">
            <span class="align-self-center mt-1">{{groups.length}}</span>
          </div>
          <p class="circle-name">GROUPS</p>
        </div>
        <div>
          <div class="circle summary-box">
            <span class="align-self-center mt-1">{{countDevices()}}</span>
          </div>
          <p class="circle-name">DEVICES</p>
        </div>
      </div>
      <div 
        *ngIf="groups.length === 0"
        class="summary-card d-flex justify-content-center align-items-center">
        No available groups detected
      </div>
    </div>
  </div>
  <!-- Devices status timeline info card for all -->
  <div class="col-lg-8 h-100">
    <div class="card p-4 h-100">
      <div class="card-title-c">
        <h5>DEVICES STATUS TIMELINE</h5>
      </div>
      <div 
        *ngIf="countGroupDevices(activeGroupId) === 0" 
        class="h-100 d-flex justify-content-center align-items-center box-line-chart text-center"> 
        No devices
      </div>
      <div *ngIf="countGroupDevices(activeGroupId) > 0" class="box-line-chart">
        <ngx-charts-line-chart
          [scheme]="colorScheme"
          [results]="devicesChart"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [gradient]="gradient" 
          [showXAxisLabel]="showXAxisLabel"
          [showYAxisLabel]="showYAxisLabel"
          [yScaleMin]="0"
          [yScaleMax]="100"
          [showGridLines]="showGridLines"
          [showRefLines]="showRefLines"
          [schemeType]="schemeType"
          [customColors]="customColors"
          [rangeFillOpacity]="rangeFillOpacity"
          [referenceLines]="referenceLines"
          [showRefLabels]="showRefLabels"
          >
        </ngx-charts-line-chart>
        <div class="y-axis-line-chart">
          <span class="grey">100%</span>
          <span class="grey mb-4">0%</span>
        </div>  
      </div>
    </div>
  </div>
</div>
<span *ngIf="groups && groups.length > 0">
  <span *ngFor="let group of groups">
    <div *ngIf="activeGroupId === group.device_group_id"  class="row row-info">
      <!-- Summary group info card -->
      <div  class="col-lg-4 h-100">
        <div  class="card h-100">
          <div class="card-title-c">
            <h5 class="text-uppercase">Summary {{group.name}}</h5>
          </div>
          <div class="summary-card" >
            <table class="table summary-devices-table">
              <tr>
                <th class="grey">
                  Availability
                </th>
                <td 
                  *ngIf="group.enabled" 
                  class="summary-devices-availability blue">
                  ENABLED
                </td>
                <td 
                  *ngIf="!group.enabled" 
                  class="summary-devices-availability red">
                  DISABLED
                </td>
              </tr>
              <tr>
                <th class="grey">
                  API Key
                </th>
                <td 
                  class="dark-grey" 
                  tooltip= "API Key" 
                  placement="bottom">
                  {{group.device_group_api_key}}
                </td> 
              </tr>
              <tr>
                <th class="grey">
                  Devices
                </th>
                <td class="summary-devices-running">{{countGroupDevices(group.device_group_id)}}</td>
              </tr>
              <tr>
                <th class="grey">
                    Device connectivity
                  </th>
                  <td 
                    *ngIf="group.default_device_connectivity" 
                    class="devices-availability-size blue">
                    ENABLED
                  </td>
                  <td 
                    *ngIf="!group.default_device_connectivity " 
                    class=" devices-availability-size red">
                    DISABLED
                  </td>
              </tr>
            </table>
          </div>
        </div>
      </div>
      <!-- Devices status timeline info card -->
      <div class="col-lg-8 h-100">
        <div class="card p-4 h-100">
          <div class="card-title-c">
            <h5 class="text-uppercase">{{group.name}} DEVICES STATUS TIMELINE</h5>
          </div>
          <div 
            *ngIf="countGroupDevices(activeGroupId) === 0" 
            class="h-100 d-flex justify-content-center align-items-center box-line-chart text-center"> 
            No devices
          </div>
          <div *ngIf="countGroupDevices(activeGroupId) > 0" class="box-line-chart">
            <ngx-charts-line-chart
              [scheme]="colorScheme"
              [results]="devicesChart"
              [xAxis]="showXAxis"
              [yAxis]="showYAxis"
              [gradient]="gradient" 
              [showXAxisLabel]="showXAxisLabel"
              [showYAxisLabel]="showYAxisLabel"
              [yScaleMin]="0"
              [yScaleMax]="100"
              [showGridLines]="showGridLines"
              [showRefLines]="showRefLines"
              [schemeType]="schemeType"
              [customColors]="customColors"
              [rangeFillOpacity]="rangeFillOpacity"
              [referenceLines]="referenceLines"
              [showRefLabels]="showRefLabels"
              >
            </ngx-charts-line-chart>
            <div class="y-axis-line-chart">
              <span class="grey">100%</span>
              <span class="grey mb-4">0%</span>
            </div>  
          </div>
        </div>
      </div>
    </div>
  </span>
</span>
<!-- Deployed devices list panel card-->
<div class="row row-main">
  <div class="col-lg-12 col-md-12 col-sm-12 h-100">
    <div class="card h-100 p-4">
      <div class="row">
        <div class="col-2 card-title-h">
          <h5>DEVICES</h5>
        </div>
        <!-- Devices tabs buttons -->
        <div class="col-10 devices-tab-buttons-container">
          <ul class="devices-tab-button" *ngIf="activeGroupId === 'ALL' || groups.length === 0">
            <li>
              <span class="devices-button-item blue devices-button-item-pr" (click)="addGroup()">
                <i class="material-icons">add</i>
                ADD GROUP 
              </span>
            </li>
          </ul>
          <ul class="devices-tab-button" *ngIf="activeGroupId !== 'ALL' && groups.length > 0">
            <li>
              <span class="devices-button-item blue" (click)="addGroup()">
                <i class="material-icons">add</i>
                ADD GROUP 
              </span>
            </li>
            <li>
              <span class="devices-button-item" (click)="deleteGroup()" >
                <i class="material-icons">delete</i>
                DELETE GROUP
              </span>
            </li>
            <li>
              <span 
                (click)="openGroupConfiguration()" 
                class="devices-button-item">
                <i class="material-icons">settings</i>
                CONFIGURATION
              </span>
            </li>
          </ul> 
        </div>
      </div>
      <span class="h-75 w-100" *ngIf="loadedData">
        <!-- Devices tabs -->
        <div class="row">
          <div class="col">
            <div class="devices-tab-container">
              <ul>
                <li *ngIf="displayedGroupsNamesLength < maxLabelsLength" class="devices-tab devices-tab-title">
                  <span class="grey">GROUPS</span>
                </li>
                <li 
                  *ngIf="groups.length > 0" 
                  class="devices-tab" 
                  (click)="changeActiveGroup('ALL')">
                  <span [ngClass]="amIactive('ALL')">ALL</span>
                </li>
                <li 
                  *ngIf="groups.length === 0" 
                  class="devices-tab">
                  <span class="active">ALL</span>
                </li>
                <li 
                  [ngClass]="haveIGroups(groups)"
                  (click)="swipeLeft()" 
                  class="tabs-arrow" >
                  <i class="material-icons">arrow_left</i>
                </li>
                <li 
                  *ngFor="let group of displayedGroups"
                  class="devices-tab"
                  (click)="changeActiveGroup(group.device_group_id)">
                  <span *ngIf="displayedGroups.length > 0" [ngClass]="amIactive(group.device_group_id)">
                    {{group.name}}
                  </span>
                </li>
                <li 
                  [ngClass]="haveIGroups(groups)"
                  (click)="swipeRight()"
                  class="tabs-arrow">
                  <i class="material-icons">arrow_right</i>
                </li>
              </ul>
            </div>  
          </div>
        </div>
        <div class="row justify-content-between">
          <!-- Sorting mesages -->
          <div class="col-9">  
            <p *ngIf="searchTerm && !filterField" class="sorting-message">
              Filtered by term "{{ searchTerm }}".
              <span class="blue reset-search" (click)="resetFilters(filterField)">Reset</span>
            </p>
            <p *ngIf="filterField && !searchTerm" class="sorting-message">
              Sorted by {{ getBeautyCategoryName(sortedBy) }},
              <span *ngIf="reverse">ascendant. </span>
              <span *ngIf="!reverse">descendant. </span>
              <span class="blue reset-search" (click)="resetFilters(filterField)">Reset</span>
            </p>
            <p *ngIf="filterField && searchTerm" class="sorting-message">
              Sorted by {{ getBeautyCategoryName(sortedBy) }}
              <span *ngIf="reverse">ascendant </span>
              <span *ngIf="!reverse">descendant </span>
              and filtered by term "{{ searchTerm }}".
              <span class="blue reset-search" (click)="resetFilters(filterField)">Reset</span>
            </p> 
          </div>
          <!-- Search input -->
          <div class="col-3">
            <form>
              <div class="search-box">
                <input 
                  type="text" 
                  class="form-control" 
                  name="searchTerm" 
                  placeholder="Search..." 
                  [(ngModel)]="searchTerm"> 
                  <div class="search-icon" *ngIf="searchTerm === ''">
                    <i class="material-icons">search</i>
                  </div>     
                  <div class="close-icon" *ngIf="searchTerm !== ''">
                    <i class="material-icons" (click)="resetFilters(filterField)">close</i>
                  </div>
              </div>
            </form>
          </div>      
        </div>
        <!-- No devices to show -->
        <div 
          *ngIf="groups.length > 0 && countGroupDevices(activeGroupId) === 0 && loadedData"
          class="no-devices-in-group d-flex justify-content-center align-items-center">
            No available devices registered in this group
        </div>
        <!-- Devices table -->
        <div class="table-h" *ngIf="devices && devices.length > 0 && groups.length > 0 && !requestError" >
          <table class="table-responsive table-fixed">
            <thead>
              <tr>
                <th 
                  *ngIf="activeGroupId !== 'ALL' && countGroupDevices(activeGroupId) > 0 "
                  (click)="setOrder('id')"
                  [ngClass]="getCategoryCSSClass('id')"
                  scope="col" 
                  class="col-3">
                  ID
                  <span class="expand-chevron" *ngIf="sortedBy === 'id' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'id' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th>
                <th 
                  *ngIf="activeGroupId === 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('id')"
                  [ngClass]="getCategoryCSSClass('id')"
                  scope="col" 
                  class="col-2">
                  ID
                  <span class="expand-chevron" *ngIf="sortedBy === 'id' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'id' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th>
                <th 
                  *ngIf="activeGroupId === 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('group')"
                  [ngClass]="getCategoryCSSClass('group')"
                  scope="col" 
                  class="col-2">
                  Group
                  <span class="expand-chevron" *ngIf="sortedBy === 'group' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'group' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th>
                <th 
                  *ngIf="activeGroupId !== 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('register_since')" 
                  [ngClass]="getCategoryCSSClass('register_since')"
                  scope="col" 
                  class="col-2">
                  Date
                  <span class="expand-chevron" *ngIf="sortedBy === 'register_since' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'register_since' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th>
                <th 
                  *ngIf="activeGroupId === 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('register_since')" 
                  [ngClass]="getCategoryCSSClass('register_since')"
                  scope="col" 
                  class="col-1">
                  Date
                  <span class="expand-chevron" *ngIf="sortedBy === 'register_since' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'register_since' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th>
                <th 
                  *ngIf="activeGroupId === 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('device_status_name')" 
                  [ngClass]="getCategoryCSSClass('device_status_name')"
                  scope="col" 
                  class="col-2 text-center">
                  Status
                  <span class="expand-chevron" *ngIf="sortedBy === 'device_status_name' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'device_status_name' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th> 
                <th 
                  *ngIf="activeGroupId !== 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('device_status_name')" 
                  [ngClass]="getCategoryCSSClass('device_status_name')"
                  scope="col" 
                  class="col-2 text-center">
                  Status
                  <span class="expand-chevron" *ngIf="sortedBy === 'device_status_name' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'device_status_name' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th> 
                <th 
                  *ngIf="activeGroupId === 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('labels')" 
                  [ngClass]="getCategoryCSSClass('labels')"
                  scope="col" 
                  class="col-4">
                  Labels
                  <span class="expand-chevron" *ngIf="sortedBy === 'labels' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'labels' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th>
                <th 
                  *ngIf="activeGroupId !== 'ALL' && countGroupDevices(activeGroupId) > 0"
                  (click)="setOrder('labels')" 
                  [ngClass]="getCategoryCSSClass('labels')"
                  scope="col" 
                  class="col-4">
                  Labels
                  <span class="expand-chevron" *ngIf="sortedBy === 'labels' && !reverse">
                    <i class="material-icons">expand_more</i>
                  </span>
                  <span class="expand-chevron" *ngIf="sortedBy === 'labels' && reverse">
                    <i class="material-icons">expand_less</i>
                  </span>
                </th>
                <th
                  *ngIf="activeGroupId === 'ALL' && countGroupDevices(activeGroupId) > 0"
                  scope="col" class="col-1 text-center">
                  Enabled
                </th>
                <th
                  *ngIf="activeGroupId !== 'ALL' && countGroupDevices(activeGroupId) > 0"
                  scope="col" class="col-1 text-center">
                  Enabled
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let device of getDevices() | sortBy : sortedBy : reverse : 'case-insensitive' | filter : searchTerm">
                <!-- "All" tab selected -->
                <span *ngIf="activeGroupId === 'ALL'">
                  <td class="col-2">{{device.device_id}}</td>
                  <td class="col-2">{{getGroupName(device.device_group_id)}}</td>
                  <td class="col-1">{{parseTimestampToDate(device.register_since) | date: 'dd/MM/yyyy'}}</td>  
                  <td 
                    class="text-lowercase col-2 text-center"
                    [ngClass]=
                    "{'status-dot':classStatusCheck(device.device_status_name, 'online'),
                    'status-dot-error':classStatusCheck(device.device_status_name, 'offline'),
                    'status-dot-process':classStatusCheck(device.device_status_name, 'process')}"> 
                    <span 
                      tooltip="{{device.device_status_name}}" 
                      class="tooltip-fix text-capitalize" 
                      placement="auto">
                    </span>
                    <span class="hide">
                      {{device.device_status_name}}
                    </span>
                  </td>
                  <td *ngIf="!device.labels" class="col-4">
                      <div 
                        tooltip="Add" 
                        placement="right"
                        class="add-label-button"
                        (click)="addLabel(device)">
                          <i class="material-icons i-add">add</i>  
                      </div>
                  </td>
                  <td *ngIf="device.labels" class="col-4">
                    <button 
                      (click)="onLabelClick(device.device_id, label[0], label[1])"
                      [ngClass]=
                      "{'btn-label-selected': indexOfLabelSelected(device.device_id, label[0], label[1]) >= 0 ,
                        'btn-outline-primary': indexOfLabelSelected(device.device_id, label[0], label[1]) === -1}" 
                      *ngFor="let label of labelsToString(device.labels)" 
                      class="btn-sm btn-outline-primary" 
                      >
                      {{label[0]}}: {{label[1]}} 
                    </button>
                    <div class="label-buttons">
                      <div 
                        *ngIf="isAnyLabelSelected(device.device_id) === false"
                        class="add-label-button" 
                        (click)="addLabel(device)"
                        tooltip="Add" 
                        placement="right"
                        >
                        <i class="material-icons i-add">add</i>
                      </div>
                      <div 
                        *ngIf="isAnyLabelSelected(device.device_id) === true"
                        class="delete-label-button" 
                        (click)="deleteLabel(device)"
                        tooltip="Delete" 
                        placement="right"
                        >
                        <i class="material-icons i-delete">delete</i>
                      </div>
                    </div>
                  </td>
                  <td class="col-1 text-center">
                    <span 
                      *ngIf="!device.enabled" 
                      (click)="enableSwitcher(device)"
                      class="devices-checkbox">
                      <i class="material-icons grey">check_box_outline_blank</i>
                    </span>
                    <span 
                      *ngIf="device.enabled"  
                      (click)="enableSwitcher(device)" 
                      class="devices-checkbox">
                      <i class="material-icons blue">check_box</i>
                    </span>
                  </td>
                </span>
                <!-- device.device_group_id tab selected -->
                <span *ngIf="activeGroupId === device.device_group_id" >
                    <td 
                      *ngIf="groups.length > 0 && countGroupDevices(device.device_group_id) === 0"
                      class="col-12">
                        No available devices registered in this group
                    </td>
                  <td class="col-3">{{device.device_id}}</td>
                  <td class="col-2">{{parseTimestampToDate(device.register_since) | date: 'dd/MM/yyyy'}}</td>  
                  <td  
                    class="text-lowercase col-2 text-center"
                    [ngClass]=
                    "{'status-dot':classStatusCheck(device.device_status_name, 'online'),
                    'status-dot-error':classStatusCheck(device.device_status_name, 'offline'),
                    'status-dot-process':classStatusCheck(device.device_status_name, 'process')}"> 
                    <span 
                      tooltip="{{device.device_status_name}}" 
                      class="tooltip-fix text-capitalize" 
                      placement="auto">
                    </span>
                    <span class="hide">
                      {{device.device_status_name}}
                    </span>
                  </td>
                  <td *ngIf="!device.labels" class="col-4">
                      <div 
                      class="add-label-button"
                      tooltip="Add" 
                      placement="right"
                      (click)="addLabel(device)">
                        <i class="material-icons i-add">add</i>  
                    </div>
                  </td>
                  <td *ngIf="device.labels" class="col-4">
                    
                    <button 
                      (click)="onLabelClick(device.device_id, label[0], label[1])"
                      [ngClass]=
                      "{'btn-label-selected': indexOfLabelSelected(device.device_id, label[0], label[1]) >= 0 ,
                        'btn-outline-primary': indexOfLabelSelected(device.device_id, label[0], label[1]) === -1}" 
                      *ngFor="let label of labelsToString(device.labels)" 
                      class="btn-sm btn-outline-primary" 
                      >
                      {{label[0]}}: {{label[1]}}
                    </button>
                    <div class="label-buttons">
                        <div 
                          *ngIf="isAnyLabelSelected(device.device_id) === false"
                          class="add-label-button" 
                          (click)="addLabel(device)"
                          tooltip="Add" 
                          placement="right"
                          >
                          <i class="material-icons i-add">add</i>
                        </div>
                        <div 
                          *ngIf="isAnyLabelSelected(device.device_id) === true"
                          class="delete-label-button" 
                          (click)="deleteLabel(device)"
                          tooltip="Delete" 
                          placement="right"
                          >
                          <i class="material-icons i-delete">delete</i>
                        </div>
                      </div>
                  </td>
                  <td class="col-1 text-center">
                    <span 
                      *ngIf="!checkBox" 
                      class="devices-checkbox"
                      (click)="enableSwitcher(device)">
                      <i class="material-icons grey">check_box_outline_blank</i>
                    </span>
                    <span 
                      *ngIf="checkBox"  
                      (click)="enableSwitcher(device)" 
                      class="devices-checkbox">
                      <i class="material-icons blue">check_box</i>
                    </span>
                  </td>
                </span>
              </tr>
            </tbody>
          </table>
        </div>
          <!-- No info to show -->
        <div 
          *ngIf="groups.length === 0 && !requestError"
          class="no-devices d-flex justify-content-center align-items-center">
          No available groups have been created. Add a new group to be able to register devices in it.
        </div>
          <!-- Requested error -->
        <div
          *ngIf="requestError"
          class="no-elements d-flex justify-content-center align-items-center">
          <p>{{ requestError }}</p>
        </div>
      </span>
      <!-- Loader -->
      <div class="nalej-loader-container h-100 w-100" *ngIf="!loadedData">
        <div class="loader">
          <svg 
            class="circular" 
            viewBox="25 25 50 50">
            <circle 
              class="path" 
              cx="50" 
              cy="50" 
              r="20" 
              fill="none" 
              stroke-width="2" 
              stroke-miterlimit="10"/>
          </svg>
        </div>
      </div>
    </div>
  </div>
</div>