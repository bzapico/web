<!-- Component title -->
<div class="row row-title">
  <div class="col-lg-12">
    <h2 class="section-title">Applications</h2>
  </div>
</div>
<div class="row row-app-main">
  <div class="col-4 h-100">
    <div class="flex-col-app">
      <!-- Application instances id card -->
      <div class="card row-info-app flex-grow-0">
        <div class="card-title-name">
          <h5>
            <a 
              [routerLink]="['/applications']" 
              routerLinkActive="active" 
              class="blue">
              APPS
            </a>
            <span class="grey"> > </span>
            <b>INSTANCE</b>
            <span class="grey"> > </span>
            <span class="grey text-uppercase">
            {{instance.name}}
            </span>
          </h5>
        </div>
          <div class="summary-instance-card">
            <div class="ins-info-box">
              <table class="table summary-instances-table">
                <tr>
                  <th>Status</th>
                  <td [ngClass]="instanceClassStatusCheck(instance.status_name)" id="summary-instances-status">
                    {{instance.status_name}}
                  </td>
                </tr>
                <tr>
                  <th>Instance of</th>
                  <!-- GET REGISTERED AND SET THE RIGHT NAME --> 
                  <td class="text-uppercase">{{getDescriptorName(instance.app_descriptor_id)}}</td> 
                </tr>
                <tr>
                  <th>ID</th>
                  <td>{{instance.app_instance_id}}</td>
                </tr>
                <tr >
                  <th>Registered app ID</th>
                  <td>{{instance.app_descriptor_id}}</td> 
                </tr>
                <tr>
                  <th>Groups</th>
                  <td *ngIf="instance && instance.groups" id="summary-instances-data">{{instance.groups.length}}</td> 
                  <td *ngIf="!instance || !instance.groups" id="summary-instances-data">0</td> 
                </tr>
                <tr>
                  <th>Service instances</th>
                  <td id="summary-instances-data">{{countGroupServices('ALL')}}</td> 
                </tr>
              </table>
            </div>
            <button (click)="undeploy(instance)" class="btn-undeploy btn-p-fix">
              <i class="material-icons i-options">close</i>
                Undeploy instance
            </button>
          </div>
      </div>
      <!-- Labels card-->
      <div class="card row-app-labels flex-grow-1">
        <div class="card-title-name hide-title-sm mb-3">
          <h5>LABELS</h5>
        </div>
        <div *ngIf="instance.labels">
          <div *ngFor="let label of instanceLabelsToString()">
            <button disabled class="btn-sm btn-outline-primary">
              {{label[0]}}: {{label[1]}}
            </button>
          </div>
        </div>
        <div *ngIf="!instance.labels" class="no-elements">
        <div class="no-elements">
          No labels
        </div>
      </div>
      </div>
    </div>
  </div>
  <div class="col-8 h-100">
    <div class="flex-col-app">
      <!-- Graph card -->
      <div *ngIf="showGraph" class="card row-app-services">
        <div class="row">
          <div class="col-10 card-title-name">
            <h5>SERVICES</h5>
          </div>
          <div class="col-2">
            <div class="show-graph-icons">
              <i 
                (click)="selectDisplayMode('list')"
                [ngClass]="!showGraph ? 'blue' : 'grey'"
                tooltip="Services" 
                placement="left"
                class="material-icons float-right">
                view_list
              </i>
              <i 
                (click)="selectDisplayMode('graph')"
                [ngClass]="showGraph ? 'blue' : 'grey'"
                tooltip="Graph" 
                placement="left"
                class="material-icons float-right mr-bars">
                bar_chart
              </i>
            </div> 
          </div>
        </div>
        <div *ngIf=
          "graphDataLoaded &&
          !graphReset &&
          countGroupServices('ALL') > 0" 
          class="graph">
            <ngx-graph
              [view]="view"
              [legend]="showLegend"
              [links]="graphData.links"
              [nodes]="graphData.nodes"
              [scheme]="colorScheme"
              [orientation]="orientation"
              [autoZoom]="autoZoom"
              [autoCenter]="autoCenter"
              [curve]="curve"
              [enableZoom]="enableZoom"
              class="chart-container">
              <ng-template #nodeTemplate let-node>
                <svg:g 
                  class="node"
                  ngx-tooltip
                  [tooltipPlacement]="'top'"
                  [tooltipType]="'tooltip'"
                  [tooltipTitle]="node.tooltip">
                  <svg:rect 
                  [attr.width]="node.width" 
                  [attr.height]="node.height" 
                  [attr.fill]="node.color" 
                  rx="14" 
                  ry="14"
                  />
                  <svg:text 
                    alignment-baseline="central" 
                    [attr.x]="10" 
                    [attr.y]="node.height/2">
                    {{node.label}}
                </svg:text>
                </svg:g>
              </ng-template>
              <ng-template #linkTemplate let-link>
                <svg:g class="edge">
                  <defs>
                    <marker 
                      id="arrow" 
                      markerWidth="13" 
                      markerHeight="13" 
                      refX="2" 
                      refY="6" 
                      orient="auto" 
                      markerUnits="userSpaceOnUse">
                        <path d="M2,2 L2,11 L10,6 L2,2" fill="#333" stroke-width="0" />
                    </marker>
                  </defs>
                  <svg:path
                    stroke-width="2"
                    class="line"
                    d="M 0,30 h100"
                    [attr.marker-mid]="getMarker(link)">
                  </svg:path>
                </svg:g>
              </ng-template>
            </ngx-graph>
          </div>
          <div *ngIf="!graphReset && countGroupServices('ALL') !== 0" class="row mt-2 text-right mr-1">
            <div class="col graph-subtext">
              Auto refresh every 5 seconds. Scroll on graph to zoom. 
              <a (click)="resetGraphZoom()" class="blue cursor-pointer">Reset</a>
            </div>
          </div>
        <div *ngIf="!graphDataLoaded" class="loader"></div>
        <!-- No info to show -->
        <div *ngIf="graphDataLoaded && countGroupServices('ALL') === 0" class="no-elements">
          No available services
        </div>
      </div>
      <!-- Services card -->
      <div *ngIf="!showGraph" class="card row-app-services">
        <div class="row">
          <div class="col-10 card-title-name">
            <h5>SERVICES</h5>
          </div>
            <div class="col-2">
              <div class="show-graph-icons">
                <i 
                  (click)="selectDisplayMode('list')"
                  [ngClass]="!showGraph ? 'blue' : 'grey'"
                  tooltip="Services" 
                  placement="left"
                  class="material-icons float-right">
                  view_list
                </i>
                <i 
                  (click)="selectDisplayMode('graph')"
                  [ngClass]="showGraph ? 'blue' : 'grey'"
                  tooltip="Graph" 
                  placement="left"
                  class="material-icons float-right mr-bars" >
                  bar_chart
                </i>
              </div> 
          </div>
        </div>
        <!-- Services tabs -->
        <div *ngIf=
          "instance &&
          instance.groups &&
          instance.groups.length > 0" 
          class="row">
          <div class="col">
            <div class="nalej-tab-box">
              <ul>
                <li *ngIf="displayedGroupsNamesLength < maxLabelsLength" class="nalej-tab nalej-tab-title">
                  <span class="grey">GROUP INSTANCES</span>
                </li>
                <li 
                  *ngIf="groups && groups.length > 0" 
                  (click)="changeActiveGroup('ALL')" 
                  class="nalej-tab">
                  <span [ngClass]="amIactive('ALL')">ALL</span>
                </li>
                <li *ngIf="groups && groups.length === 0" class="nalej-tab">
                  <span class="active">ALL</span>
                </li>
                <li 
                  (click)="swipeLeft()" 
                  [ngClass]="haveIGroups(groups)" 
                  class="tabs-arrow">
                  <i class="material-icons">arrow_left</i>
                </li>
                <li 
                  *ngFor="let group of displayedGroups" 
                  (click)="changeActiveGroup(group.service_group_instance_id)"
                  class="nalej-tab" >
                  <span 
                    *ngIf="displayedGroups.length > 0" 
                    [ngClass]="amIactive(group.service_group_instance_id)">
                    {{group.name}} - {{getLastChars(3, group.service_group_instance_id)}}
                  </span>
                </li>
                <li 
                  (click)="swipeRight()" 
                  [ngClass]="haveIGroups(groups)" 
                  class="tabs-arrow">
                  <i class="material-icons">arrow_right</i>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div *ngIf=
          "instance &&
          instance.groups &&
          instance.groups.length > 0"
          class="row mb-3 hide-md-h">
          <!-- Sorting mesages -->
          <div class="col-9">
            <p *ngIf="searchTerm && !filterField" class="sorting-message">
              Filtered by term "{{ searchTerm }}".
              <span (click)="resetFilters('services')" class="reset-search">Reset</span>
            </p>
            <p *ngIf="filterField && !searchTerm" class="sorting-message">
              Sorted by {{ sortedBy }},
              <span *ngIf="reverse">ascendant. </span>
              <span *ngIf="!reverse">descendant. </span>
              <span (click)="resetFilters('services')" class="reset-search">Reset</span>
            </p>
            <p *ngIf="filterField && searchTerm" class="sorting-message">
              Sorted by {{ sortedBy }}
              <span *ngIf="reverse">ascendant </span>
              <span *ngIf="!reverse">descendant </span>
              and filtered by term "{{ searchTerm }}".
              <span (click)="resetFilters('services')" class="reset-search">Reset</span>
            </p>
          </div>
          <!-- Search input -->
          <div class="col-3">
            <form>
              <div class="search-box">
                <input 
                  name="searchTerm" 
                  [(ngModel)]="searchTerm"
                  type="text" 
                  placeholder="Search..."
                  class="form-control">
                <div *ngIf="searchTerm === ''" class="search-icon">
                  <i class="material-icons">search</i>
                </div>
                <div *ngIf="searchTerm !== ''" class="close-icon">
                  <i (click)="resetFilters('services')" class="material-icons">close</i>
                </div>
              </div>
            </form>
          </div>
        </div>
        <!-- No services to show -->
        <div *ngIf="activeGroupId!== 'ALL' && countGroupServices(activeGroupId) === 0" class="no-elements-in-group">
          No available services in this group
        </div>
        <!-- Services table -->
        <div *ngIf=
          "instance &&
          instance.groups &&
          instance.groups.length > 0"
          role="table" 
          aria-label="Services table"
          class="nalej-flex-table-box">
          <div role="rowgroup" class="nalej-flex-table nalej-flex-th">
            <div 
              (click)="setOrder('services','name')"
              role="columnheader" 
              [ngClass]="getCategoryCSSClass('services','name')"
              class="nalej-flex-row-5 services-cell-1 wider-cell" >
              <span tooltip="Name" placement="bottom">Name</span>
              <span *ngIf="sortedBy === 'name' && !reverse" class="expand-chevron">
                <i class="material-icons">expand_more</i>
              </span>
              <span *ngIf="sortedBy === 'name' && reverse" class="expand-chevron">
                <i class="material-icons">expand_less</i>
              </span>
            </div>
            <div 
              (click)="setOrder('services','replicas')" 
              role="columnheader"    
              [ngClass]="getCategoryCSSClass('services','replicas')"
              class="nalej-flex-row-5 services-cell-2">
              <span tooltip="Replicas" placement="bottom">Replicas</span>
              <span *ngIf="sortedBy === 'replicas' && !reverse" class="expand-chevron">
                <i class="material-icons">expand_more</i>
              </span>
              <span *ngIf="sortedBy === 'replicas' && reverse" class="expand-chevron">
                <i class="material-icons">expand_less</i>
              </span>
            </div>
            <div
              (click)="setOrder('services','status')" 
              role="columnheader"
              [ngClass]="getCategoryCSSClass('services','status')"
              class="nalej-flex-row-5 services-cell-3">
              <span tooltip="Status" placement="bottom">Status</span>
              <span *ngIf="sortedBy === 'status' && !reverse" class="expand-chevron">
                <i class="material-icons">expand_more</i>
              </span>
              <span *ngIf="sortedBy === 'status' && reverse" class="expand-chevron">
                <i class="material-icons">expand_less</i>
              </span>
            </div>
            <div  
              (click)="setOrder('services','endpoints')" 
              [ngClass]="getCategoryCSSClass('services','endpoints')" 
              role="columnheader"  
              class="nalej-flex-row-5 services-cell-4">
              <span tooltip="Endpoints" placement="bottom">Endpoints</span>
              <span *ngIf="sortedBy === 'endpoints' && !reverse" class="expand-chevron">
                <i class="material-icons">expand_more</i>
              </span>
              <span *ngIf="sortedBy === 'endpoints' && reverse" class="expand-chevron">
                <i class="material-icons">expand_less</i>
              </span>
            </div>
            <div class="nalej-flex-row-5 services-cell-5" role="columnheader">
              <span tooltip="Info" placement="bottom">Info</span>
            </div>
          </div>
          <span *ngIf="getGroupServices(activeGroupId)">
            <div *ngFor=
              "let service of getGroupServices(activeGroupId) |
              sortBy : sortedBy : reverse : 'case-insensitive' |
              filter : searchTerm"
              role="rowgroup" 
              class="nalej-flex-table row" >
              <div role="cell" class="nalej-flex-row-5 services-cell-1 nalej-flex-td wider-cell"> 
                {{service.name}}
              </div>
              <div role="cell" class="nalej-flex-row-5 services-cell-2 nalej-flex-td">
                {{service.specs.replicas}}
              </div>
              <div 
                [ngClass]="getServiceStatusClass(service.status_name)"
                role="cell" 
                class="nalej-flex-row-5 services-cell-3 nalej-flex-td text-lowercase">
                  {{getBeautyStatusName(service.status_name)}}
              </div>
              <div role="cell" class="nalej-flex-row-5 services-cell-4 nalej-flex-td">
                <span *ngFor="let endpoint of service.endpoints">
                    <a 
                      *ngIf="endpoint" 
                      href="{{getEndpointHref(endpoint)}}" 
                      target="_blank">
                      {{endpoint}}
                    </a>
                  </span>
                <span *ngIf="!service.endpoints">No</span>
              </div>
              <div role="cell" class="nalej-flex-row-5 services-cell-5 nalej-flex-td">
                <div    
                  (click)="openServicesInfo(service)" 
                  tooltip="Info" 
                  placement="left">
                  <i class="material-icons info-icon">info</i>
                </div>
              </div>
            </div>
          </span>
        </div> 
        <!-- No info to show -->
        <div *ngIf=
          "loadedData &&
          !requestError &&
          groups.length === 0" 
          class="no-elements">
          No available services
        </div>
        <!-- Requested error -->
        <div *ngIf="loadedData && requestError" class="no-elements">
          <p>{{ requestError }}</p>
        </div>
        <!-- Loader -->
        <div *ngIf="!loadedData" class="nalej-loader-box">
          <div class="loader">
            <svg class="circular" viewBox="25 25 50 50">
              <circle 
                class="path" 
                cx="50" 
                cy="50" 
                r="20" 
                fill="none" 
                stroke-width="2" 
                stroke-miterlimit="10" />
            </svg>
          </div>
        </div>
      </div>
      <div class="row row-app-rules ">
        <!-- Rules card -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-title-name">
              <h5>RULES</h5>
            </div>
            <div *ngIf=
              "loadedData &&
              instance.rules &&
              instance.rules.length > 0 &&
              !requestError" 
              class="row mb-3 hide-md-h">
              <!-- Sorting mesages -->
              <div class="col">
                <p *ngIf="searchTermRules && !filterFieldRules" class="sorting-message">
                  Filtered by term "{{ searchTermRules }}".
                  <span (click)="resetFilters('rules')" class="reset-search">Reset</span>
                </p>
                <p *ngIf="filterFieldRules && !searchTermRules" class="sorting-message">
                  Sorted by {{ sortedByRules }},
                  <span *ngIf="reverse">ascendant. </span>
                  <span *ngIf="!reverse">descendant. </span>
                  <span (click)="resetFilters('rules')" class="reset-search">Reset</span>
                </p>
                <p *ngIf="filterFieldRules && searchTermRules" class="sorting-message">
                  Sorted by {{ sortedByRules }}
                  <span *ngIf="reverse">ascendant </span>
                  <span *ngIf="!reverse">descendant </span>
                  and filtered by term "{{ searchTermRules }}".
                  <span (click)="resetFilters('rules')" class="reset-search">Reset</span>
                </p>
              </div>
              <!-- Search input -->
              <div class="col-6">
                <form>
                  <div class="search-box">
                    <input 
                      name="searchTermRules" 
                      [(ngModel)]="searchTermRules"
                      type="text" 
                      placeholder="Search..."
                      class="form-control">
                    <div *ngIf="searchTermRules === ''" class="search-icon">
                      <i class="material-icons">search</i>
                    </div>
                    <div  *ngIf="searchTermRules !== ''" class="close-icon">
                      <i class="material-icons" (click)="resetFilters('rules')">close</i>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <!-- Rules table -->
            <div *ngIf=
                "loadedData &&
                instance.rules &&
                instance.rules.length > 0 &&
                !requestError" 
                role="table" 
                aria-label="Rules table"
                class="nalej-flex-table-box hide-xs" >
                <div role="rowgroup" class="nalej-flex-table nalej-flex-th">
                  <div 
                    (click)="setOrder('rules','name')"
                    [ngClass]="getCategoryCSSClass('rules','name')"
                    role="columnheader" 
                    class="nalej-flex-row-5 rules-cell-1 wider-cell">
                    <span tooltip="Name" placement="bottom">Name</span>
                    <span *ngIf="sortedByRules === 'name' && !reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_more</i>
                    </span>
                    <span *ngIf="sortedByRules === 'name' && reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_less</i>
                    </span>
                  </div>
                  <div 
                    (click)="setOrder('rules','access')" 
                    [ngClass]="getCategoryCSSClass('rules','access')" 
                    role="columnheader"  
                    class="nalej-flex-row-5 rules-cell-2">
                    <span tooltip="Access" placement="bottom">Access</span> 
                    <span *ngIf="sortedByRules === 'access' && !reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_more</i>
                    </span>
                    <span *ngIf="sortedByRules === 'access' && reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_less</i>
                    </span>
                  </div>
                  <div 
                    (click)="setOrder('rules','target')" 
                    [ngClass]="getCategoryCSSClass('rules','target')" 
                    role="columnheader" 
                    class="nalej-flex-row-5 rules-cell-3">
                    <span tooltip="Target (group, service, port)"  placement="bottom">
                      Target <span class="grey typo-small">(g - s - p)</span>
                    </span>
                    <span *ngIf="sortedByRules === 'target' && !reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_more</i>
                    </span>
                    <span *ngIf="sortedByRules === 'target' && reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_less</i>
                    </span>
                  </div>
                  <div 
                    (click)="setOrder('rules','auth')" 
                    [ngClass]="getCategoryCSSClass('rules','auth')" 
                    role="columnheader"  
                    class="nalej-flex-row-5 rules-cell-4">
                    <span tooltip="Auth (group, service / device group)" placement="bottom">
                      Auth <span class="grey typo-small">(g - s/d)</span>
                    </span>
                    <span *ngIf="sortedByRules === 'auth' && !reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_more</i>
                    </span>
                    <span *ngIf="sortedByRules === 'auth' && reverseRules" class="expand-chevron">
                      <i class="material-icons">expand_less</i>
                    </span>
                  </div>
                  <div class="nalej-flex-row-5 rules-cell-4" role="columnheader">
                    <span tooltip="Info" placement="bottom">Info</span>
                  </div>
                </div>
                <div *ngFor=
                  "let rule of instance.rules |
                  sortBy : sortedByRules : reverseRules : 'case-insensitive' |
                  filter : searchTermRules"
                  role="rowgroup"
                  class="nalej-flex-table row">
                  <div role="cell" class="nalej-flex-row-5 rules-cell-1 nalej-flex-td wider-cell"> 
                      {{rule.name | truncate}}
                  </div>
                  <div role="cell" class="nalej-flex-row-5 rules-cell-2 nalej-flex-td">{{rule.access_name}}</div>
                  <div role="cell" class="nalej-flex-row-5 rules-cell-3 nalej-flex-td">
                      {{rule.target_service_group_name}} - {{rule.target_service_name}} - {{rule.target_port}}
                  </div>
                  <div role="cell" class="nalej-flex-row-5 rules-cell-4 nalej-flex-td">
                      {{rule.auth_service_group_name}}
                      <span *ngIf="rule.auth_services"> - </span>
                      {{rule.auth_services}}
                      <span *ngIf="rule.device_group_names"></span>
                      {{rule.device_group_names}}
                  </div>
                  <div role="cell" class="nalej-flex-row-5 rules-cell-5 nalej-flex-td">
                    <div    
                      (click)="openRulesInfo(rule)"
                      tooltip="Info" 
                      placement="left">
                      <i class="material-icons info-icon">info</i>
                    </div>
                  </div>
                </div>
            </div>
            <!-- Rules info button for small vieports -->
            <div *ngIf=
              "loadedData &&
              instance.rules &&
              instance.rules.length > 0 &&
              !requestError"
              class="rules-info-sm-table-box">
              <div *ngFor="let rule of instance.rules"class="rules-info-sm-table">
                <div class="rules-info-sm-text">{{rule.name}}</div>
                <div    
                  (click)="openRulesInfo(rule)"
                  tooltip="Info" 
                  placement="left">
                  <i class="material-icons info-icon">info</i>
                </div>
              </div>
            </div>
            <!-- No info to show -->
            <div *ngIf=
              "loadedData &&
              instance &&
              !instance.rules
              !requestError" 
              class="no-elements">
              No available rules detected
            </div>
            <!-- Requested error -->
            <div *ngIf="loadedData && requestError" class="no-elements">
              <p>{{requestError}}</p>
            </div>
            <!-- Loader -->
            <div *ngIf="!loadedData" class="nalej-loader-box">
              <div class="loader">
                <svg class="circular" viewBox="25 25 50 50">
                  <circle 
                    class="path" 
                    cx="50" 
                    cy="50" 
                    r="20" 
                    fill="none" 
                    stroke-width="2" 
                    stroke-miterlimit="10" />
                </svg>
              </div>
            </div>
          </div>
        </div>
        <!-- Configuration card -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-title-name">
              <h5>CONFIGURATION</h5>
            </div>
            <div class="config-card">
              <div *ngIf="instance.environment_variables">
                <p class="text-left">Environment variables</p>
                <div *ngFor="let variable of objectToString(instance.environment_variables)" class="row mb-2" >
                  <div class="col-12 grey text-right">
                    {{variable[0]}} 
                  </div>
                  <div class="col-12 text-right">
                    {{variable[1]}}
                  </div>
                </div>
              </div>
              <div *ngIf="!instance.environment_variables">
                <p class="text-left">Environment variables</p>
                <p class="grey">No environment variables have been set</p>
              </div>
              <div *ngIf="instance.configuration_options">
                <p class="text-left">Other settings</p>
                <div *ngFor="let configuration of objectToString(instance.configuration_options)" class="row mb-1" >
                  <div class="col-12 grey text-right">
                    {{configuration[0]}} 
                  </div>
                  <div class="col-12 text-right">
                    {{configuration[1]}}
                  </div>
                </div>
              </div>
              <div *ngIf="!instance.configuration_options">
                <p class="text-left">Other settings</p>
                <p class="grey">No extra settings have been set</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>