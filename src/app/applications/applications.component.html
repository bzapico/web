<!-- Component title -->
<div class="row row-title">
  <div class="col-lg-12">
    <h2 class="section-title">Applications</h2>
  </div>
</div>
<div class="row row-info">
  <!-- Summary app info card -->
  <div class="col-lg-4 h-100">
    <div class="card p-4">
      <div class="card-title-name">
        <h5>SUMMARY</h5>
      </div>
      <div class="summary-card">
        <div>
          <div class="deployed-box">
            <div 
              *ngIf="instances.length >0"
              class="donut-chart">
              <ngx-charts-pie-chart
                [scheme]="colorScheme" 
                [results]="instancesPieChart" 
                [doughnut]= "doughnut"
                [gradient]="gradient"
                [explodeSlices]="false"
                >
              </ngx-charts-pie-chart>
              <div class="donut-number">{{countRunning}}/{{instances.length}}</div>
            </div>
            <p *ngIf="instances.length > 0" class="blue text-center apps-run mb-0">Apps running</p>
            <p *ngIf="instances.length === 0" class="circle-name no-deployed">NO APPS DEPLOYED</p>
            <p *ngIf="instances.length > 0" class="circle-name my-0">DEPLOYED</p>
          </div>
        </div>
        <div class="summary-box">
          <div class="circle">
            <span>{{registered.length}}</span>
          </div>
          <p class="circle-name">REGISTERED</p>
        </div>
      </div>
    </div>
  </div>
  <!-- App status timeline info card -->
  <div class="col-lg-8 h-100">
    <div class="card p-4">
      <div class="card-title-name">
        <h5>APP STATUS TIMELINE</h5>
      </div>
      <div 
        *ngIf="instances.length === 0" 
        class="h-100 no-elements"> 
        No applications deployed yet
      </div>
      <div *ngIf="instances.length>0" class="line-chart-box">
        <ngx-charts-line-chart
          [scheme]="colorScheme"
          [results]="appsChart"
          [xAxis]="showXAxis"
          [yAxis]="showYAxis"
          [gradient]="gradient" 
          [showXAxisLabel]="showXAxisLabel"
          [showYAxisLabel]="showYAxisLabel"
          [yScaleMin]="0"
          [yScaleMax]="100"
          [showGridLines]="showGridLines"
          [showRefLines]="showRefLines"
          [schemeType]="schemeType"
          [customColors]="customColors"
          [rangeFillOpacity]="rangeFillOpacity"
          [referenceLines]="referenceLines"
          [showRefLabels]="showRefLabels"
          >
        </ngx-charts-line-chart>
        <div class="line-chart-y-axis">
          <span class="grey">100%</span>
          <span class="grey mb-4">0%</span>
        </div>  
      </div>
    </div>
  </div>
</div>
<!-- Deployed app list panel card-->
<div class="row row-main">
  <div class="col-lg-12 col-md-12 col-sm-12 h-100">
    <div class="card p-4">
      <div class="card-title-name-mb">
        <h5>APPLICATIONS</h5>
      </div>
      <div class="apps-options">
        <button 
          (click)="deployInstance()"
          *ngIf="showInstances" 
          class="apps-actions-btn btn-p-fix">
          <i class="material-icons i-options">play_arrow</i>
          Deploy instance
        </button>
        <button
          (click)="registerApp()"
          *ngIf="!showInstances"
          class="apps-actions-btn btn-p-fix"
          >
          <i class="material-icons i-options">publish</i>
          Register application
        </button>
      </div>
      <!-- Applications tabs -->
      <div class="row">
        <div class="col">
          <div class="nalej-tab-box">
            <ul>
              <li class="nalej-tab nalej-tab-title">
                <span class="grey">LISTS</span>
              </li>
              <li 
                class="nalej-tab"
                (click)="changeActiveList('instances')">
                <span [ngClass]="{'active': showInstances}">
                  INSTANCES
                </span>
              </li>
              <li 
                class="nalej-tab"
                (click)="changeActiveList('registered')">
                <span [ngClass]="{'active': !showInstances}">
                  REGISTERED
                </span>
              </li>
            </ul>
          </div>  
        </div>
      </div>
      <div class="row justify-content-between">
        <!-- Sorting mesages -->
          <div class="col-9">  
            <p *ngIf="searchTerm && !filterField" class="sorting-message">
              Filtered by term "{{ searchTerm }}".
              <span class="blue reset-search" (click)="resetFilters(filterField)">Reset</span>
            </p>
            <p *ngIf="filterField && !searchTerm" class="sorting-message">
              Sorted by {{ sortedBy }},
              <span *ngIf="reverse">ascendant. </span>
              <span *ngIf="!reverse">descendant. </span>
              <span class="blue reset-search" (click)="resetFilters(filterField)">Reset</span>
            </p>
            <p *ngIf="filterField && searchTerm" class="sorting-message">
              Sorted by {{ sortedBy }}
              <span *ngIf="reverse">ascendant </span>
              <span *ngIf="!reverse">descendant </span>
              and filtered by term "{{ searchTerm }}".
              <span class="blue reset-search" (click)="resetFilters(filterField)">Reset</span>
            </p> 
          </div>
          <!-- Search input -->
          <div class="col-3">
            <form>
              <div class="search-box">
                <input 
                  type="text" 
                  class="form-control" 
                  name="searchTerm" 
                  placeholder="Search..." 
                  [(ngModel)]="searchTerm"> 
                  <div class="search-icon" *ngIf="searchTerm === ''">
                    <i class="material-icons">search</i>
                  </div>     
                  <div class="close-icon" *ngIf="searchTerm !== ''">
                    <i class="material-icons" (click)="resetFilters(filterField)">close</i>
                  </div>
              </div>
            </form>
          </div>      
      </div>
      <!-- App Instances -->
      <div class="table-h" *ngIf="loadedData && instances && instances.length > 0 && !requestError && showInstances">
        <table class="table-responsive table-fixed">
          <thead>
            <tr>
              <th 
                (click)="setOrder('name')"            
                [ngClass]="getCategoryCSSClass('name')"
                scope="col" 
                class="col-2">
                Name 
                <span class="expand-chevron" *ngIf="sortedBy === 'name' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'name' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th 
                (click)="setOrder('id')"
                [ngClass]="getCategoryCSSClass('id')"
                scope="col" 
                class="col-3">
                ID
                <span class="expand-chevron" *ngIf="sortedBy === 'id' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'id' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th 
                (click)="setOrder('labels')" 
                [ngClass]="getCategoryCSSClass('labels')"
                scope="col" 
                class="col-4">
                Labels
                <span class="expand-chevron" *ngIf="sortedBy === 'labels' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'labels' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th 
                (click)="setOrder('status')" 
                [ngClass]="getCategoryCSSClass('status')"
                scope="col" 
                class="col-2 text-center">
                Status
                <span class="expand-chevron" *ngIf="sortedBy === 'status' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'status' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th scope="col" class="col-1 text-center">
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of instances | sortBy : sortedBy : reverse : 'case-insensitive' | filter : searchTerm">
              <td 
                tooltip="Info"
                placement="top"
                class="text-capitalize col-2 app-info" 
                [routerLink]="['instance', app.app_instance_id]" 
                routerLinkActive="active"
                >
                {{app.name}}
              </td>
              <td class="col-3">{{app.app_instance_id}}</td>
              <td class="col-4">
                <button *ngFor="let label of labelsToString(app.labels)" class="btn-sm btn-outline-primary" disabled>
                  {{label[0]}}: {{label[1]}}
                </button>
              </td>
              <td 
                class="col-2 col-center-lowercase"
                [ngClass]=
                "{'status-dot':classStatusCheck(app.status_name, 'running'),
                'status-dot-error':classStatusCheck(app.status_name, 'error'),
                'status-dot-process':classStatusCheck(app.status_name, 'process')}"> 
                <span tooltip="{{app.status_name | lowercase}}" class="tooltip-fix" placement="auto">
                </span>
                <span class="hide">
                  {{app.status_name}}
                </span>
              </td>
              <td class="row-info-btn col-1 text-center">
                <button tooltip="Undeploy" placement="left" class="btn-grey" (click)="undeploy(app)">
                  <i class="material-icons i-red">close</i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
       <!-- No app instances to show -->
      <div 
        *ngIf="loadedData && instances && instances.length === 0 && !requestError && showInstances"
        class="no-elements">
        No application instances deployed
      </div>
      <!-- Registered Apps -->
      <div class="table-h" *ngIf="loadedData && registered && registered.length > 0 && !requestError && !showInstances">
        <table class="table-responsive table-fixed">
          <thead>
            <tr>
              <th 
                (click)="setOrder('name')"            
                [ngClass]="getCategoryCSSClass('name')"
                scope="col" 
                class="col-2">
                Name 
                <span class="expand-chevron" *ngIf="sortedBy === 'name' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'name' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th 
                (click)="setOrder('id')"
                [ngClass]="getCategoryCSSClass('id')"
                scope="col" 
                class="col-3">
                ID
                <span class="expand-chevron" *ngIf="sortedBy === 'id' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'id' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th 
                (click)="setOrder('labels')" 
                [ngClass]="getCategoryCSSClass('labels')"
                scope="col" 
                class="col-4">
                Labels
                <span class="expand-chevron" *ngIf="sortedBy === 'labels' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'labels' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th 
                (click)="setOrder('services')" 
                [ngClass]="getCategoryCSSClass('services')"
                scope="col" 
                class="col-2 text-center">
                Services
                <span class="expand-chevron" *ngIf="sortedBy === 'services' && !reverse">
                  <i class="material-icons">expand_more</i>
                </span>
                <span class="expand-chevron" *ngIf="sortedBy === 'services' && reverse">
                  <i class="material-icons">expand_less</i>
                </span>
              </th>
              <th scope="col" class="col-1 text-center">
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let app of registered| sortBy : sortedBy : reverse : 'case-insensitive' | filter : searchTerm">
              <td 
                tooltip="Info"
                placement="top"
                class="text-capitalize col-2 app-info" 
                [routerLink]="['registered', app.app_descriptor_id]" 
                routerLinkActive="active" >
                {{app.name}}
              </td>
              <td class="col-3">{{app.app_descriptor_id}}</td>
              <td class="col-4" >
                <button 
                  (click)="onLabelClick(app.app_descriptor_id, label[0], label[1])"
                  [ngClass]=
                  "{'label-btn-selected': indexOfLabelSelected(app.app_descriptor_id, label[0], label[1]) >= 0 ,
                    'btn-outline-primary': indexOfLabelSelected(app.app_descriptor_id, label[0], label[1]) === -1}" 
                  *ngFor="let label of labelsToString(app.labels)" 
                  class="btn-sm btn-outline-primary" 
                  >
                  {{label[0]}}: {{label[1]}} 
                </button>
                <div class="label-btns">
                  <div 
                    *ngIf="isAnyLabelSelected(app.app_descriptor_id) === false"
                    class="label-btn-blue" 
                    (click)="addLabel(app)"
                    tooltip="Add" 
                    placement="right"
                    >
                    <i class="material-icons i-add">
                      add
                    </i>
                  </div>
                  <div 
                    *ngIf="isAnyLabelSelected(app.app_descriptor_id) === true"
                    class="label-btn-red" 
                    (click)="deleteLabel(app)"
                    tooltip="Delete" 
                    placement="right"
                    >
                    <i class="material-icons i-delete">
                      delete
                    </i>
                  </div>
                </div>
              </td>
              <td class="col-2 text-center"> 
                  {{getServicesCount(app)}}
              </td>
              <td class="row-info-btn col-1 text-center">
                <button           
                  (click)="deployRegistered(app)"
                  tooltip="Deploy" 
                  placement="left" 
                  class="btn-blue mr-2">
                  <i class="material-icons i-white">play_arrow</i>
                </button>
                <button tooltip="Delete" placement="left" class="btn-grey btn-grey-mr" (click)="deleteApp(app)">
                  <i class="material-icons i-red">delete</i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
        <!-- No registered app to show -->
      <div 
        *ngIf="loadedData && registered && registered.length === 0 && !requestError && !showInstances"
        class="no-elements">
        No registered applications detected
      </div>
       <!-- Requested error -->
      <div
        *ngIf="loadedData && requestError"
        class="no-elements">
        <p>{{requestError}}</p>
      </div>
      <!-- Loader -->
      <div class="nalej-loader-box" *ngIf="!loadedData">
        <div class="loader">
          <svg 
            class="circular" 
            viewBox="25 25 50 50">
            <circle 
              class="path" 
              cx="50" 
              cy="50" 
              r="20" 
              fill="none" 
              stroke-width="2" 
              stroke-miterlimit="10"/>
          </svg>
        </div>
      </div>
    </div>
  </div>
</div>